# 计算机网络笔记

前三章笔记暂时不更新

## 第1章 概述

## 第2章 物理层

## 第3章 数据链路层

## 第4章 网络层

### 网络层的几个重要概念

#### 提供的两种服务

1.虚电路（VC） ❌

2.网络层向上层只提供简单灵活的、无连接的、尽最大努力交付的（IP）数据报服务

<font color=Red>网络层不提供服务质量的承诺</font>

#### 网络层两个层面

1.数据层面（转发层面）

​	转发表

2.控制层面

​	路由选择算法



​	最近网络界提出的***软件定义网络***（SDN）正对两个层面进行重大改变，有一个逻辑上集中的 ***远程控制器*** 掌握各个主机和网络的状态，能够为每一个分组计算出最佳路由，然后在每一个路由器中生成其正确的转发表

### 网络协议IP

主要内容ARP、ICMP、IGMP

<img src="./img/截屏2023-11-05 21.36.02.png" alt="截屏2023-11-05 21.36.02" style="zoom:50%;" />

#### 虚拟互联网络

连接网络的中间设备：

​	（1）物理层用 ***转发器***

​	（2）数据链路层用 ***网桥/桥接器*** 和 ***交换机***

​	（3）网络层用 ***路由器***

​	（4）网络层以上用 ***网关***

由于互连的计算机网络都使用相同的网际协议（IP），因此可以把互连以后的计算机网络看成如图所示的一个 ***虚拟互连网络***

<img src="./img/截屏2023-11-05 21.44.04.png" alt="截屏2023-11-05 21.44.04" style="zoom:50%;" />

从源主机交付数据报到目的主机：

​	不需要经过任何路由器->***直接交付***

​	需要经过一个或几个路由器->***间接交付***

分组在传送途中每一次转发称为一“跳”（hop）

#### IP地址

##### IP地址及其表示方法

IP地址：32位二进制代码，为方便可读性每8位插入一个空格<font color=Red>(机器里没有空格)</font>为了方便人们书写和记忆用 ***点分十进制记法***（每段数字写成十进制，之间加小数点）

IP地址 ::={<网络号,<主机号>}            <font color=Red>::=表示“定义为”</font>



##### 分类的IP地址

<img src="./img/截屏2023-11-05 21.56.02.png" alt="截屏2023-11-05 21.56.02" style="zoom: 33%;" />



A、B、C地址都是 ***单播地址***	D是 ***多播地址*** 	E是 ***保留地址***

A类：网络号字段固定1位，剩下7位可供使用

​	其中7位全0用作表示“本网络”，7位全1（127）保留作为本地软件 ***环回测试*** 本主机的进程之间的通信之用

对于ABCDE的主机号部分：

​	全0主机号表示“本主机”连接到的***单个网络地址***

​	全1主机号表示“所有的”（广播）

所以各类网络最大主机数都是$2^n-2$（n为主机号位数）

##### 无分类编址 

编址方法全名 ***无分类域间路由选择（CIDR）***

（1）网络前缀

CIDR记法 	IP地址::={<网络前缀>,<主机号>}/n（前缀数）

（2）地址块

CIDR把网络前缀都相同的所有连续的IP地址组成一个“CIDR 地址块”

（3）地址掩码（子网掩码）

由n个1和（32-n)个0组成，n=前缀长度

 二进制IP地址与地址掩码进行按位与运算，得到网络地址

<img src="./img/截屏2023-11-05 22.21.31.png" alt="截屏2023-11-05 22.21.31" style="zoom:50%;" />

CIDR地址中有三个特殊地址块：

「1」前缀n=32 用于 ***主机路由***

「2」前缀n=31 主机号只有0和1，用于 ***点对点链路***

「3」前缀n=0 IP地址也是全0，用于 ***默认路由***

##### IP地址的特点

IP地址由网络前缀和主机号两部分组成

IP地址标志一台主机（或路由器）和一条链路的接口 

​	<font color=Red>当一条主机连在两个网路上则需要两个对应的IP，网络前缀必须不同，这种称为 ***多归属主机***</font>

一个网络（或子网）是指具有相同网络前缀的主机的集合，转发器和交换机连接起来的局域网仍然为一个网络

所有分配到网络前缀的网络都是平等的，互联网平等对待每一个IP地址

#### IP地址与MAC地址

IP地址是网络层及以上使用的逻辑地址

MAC地址是数据链路层使用的地址

<img src="/Users/apple/Desktop/厦门大学/大三上/计算机网络与通信/笔记/img/截屏2023-11-05 22.32.42.png" alt="截屏2023-11-05 22.32.42" style="zoom: 33%;" />



#### 地址解析协议ARP

ARP作用： 在已知一个机器的IP地址情况下找出其MAC地址

主机的ARP高速缓存中会存放一个IP到MAC的映射表，映射表会动态更新（新增或超时删除）

​	因为有时候网络会更换主机，映射发生变化，所以需要一定时间删除

运行方法如下：

​	1.A要给B发IP数据报，在由映射表的情况下按表发送，映射表没B则到步骤2

​	2.在本局域网广播发送ARP请求分组

​	3.主机B发现ARP请求查询到IP和自己一致，收下ARP并向A发送ARP响应分组

​	4.自此A记录了B的映射，B记录了A的映射

​	5.该映射项目到设置的 ***生存时间*** 之后（一般10～20min）会被删除，然后重走1

如果目的主机不在源主机的局域网上，则ARP发给路由器，映射过程同上

#### IP数据报的格式

<img src="./img/截屏2023-11-05 22.44.29.png" alt="截屏2023-11-05 22.44.29" style="zoom:50%;" />

##### IP数据报首部固定部分

版本：有4和6

首部长度：占4位  表示单位为32位字长（1个32位字长4字节），最小值5（20字节固定首部长度）

​	注：IP首部必须为4字节整数倍，不满则会被填充

区分服务：一般不用

总长度： 首部和数据之和的长度 单位：字节 

​	占16位 所以数据报最大长度$2^{16} -1=65535$字节

​	数据链路层有数据部分最大传送单元MTU 1500字节，如果数据包超出则需要进行分片处理，每个分片都是首部+数据的形式

标识： 占16位 被分片后相同标识使之能重新组装

片转移： 占13位 记录每一片相对位置，以8字节位偏移单位，所以除了最后一个数据报片外每个分片的长度一定是8字节的整数倍

生存时间： 占8位，每一跳减1，到0数据报被丢弃

协议： 占8位

![截屏2023-11-05 22.58.40](./img/截屏2023-11-05 22.58.40.png)

首部检验和：占16位	 <font color=Red>这个字段只检验数据报的首部，不包括数据部分</font>

​	将数据报首部每16位一组，每组不进位相加，得到16位结果再取反得到检验和

​	每经过一个路由器都重新计算

源地址：32位

目的地址：32位



##### 可变部分

选项字段，用来排错、测量及安全等措施

### IP层转发分组的过程

#### 基于终点的转发

分组在互联网上传送和转发是基于分组首部中的目的地址，所以称为基于终点的转发

这主要是一个 ***寻找前缀匹配*** 的过程

#### 最长前缀匹配

分组转发算法：（转发表按照前缀长短排列，长的在前）

​	1.从收到的分组提取目的主机IP地址D

​	2.若查找到有特定主机路由，按这条路由下一跳转发，否则到转发表下一行（前缀最长的一行）进行检查

​	3.将本行子网掩码与目的地址按位与运算

​		若与本行前缀匹配则查找结束，按照该下一跳处理

​		若不匹配，若有下一行则检查下一行，若没有则执行4

​	4.若转发表有一个默认路由，则按照指明的接口把分组传送到指明的默认路由器

#### 使用二叉线索查找转发表

找出对应每个IP地址的唯一前缀，然后按照唯一前缀构建0/1二叉树结构

### 网际控制报文协议ICMP

ICMP允许主机或路由器报告差错情况和提供有关异常的报告

ICMP装在IP数据报的数据部分

<img src="./img/截屏2023-11-05 23.17.18.png" alt="截屏2023-11-05 23.17.18" style="zoom: 33%;" />



#### ICMP报文的种类

分两种：

​	差错报告报文

​	询问报文

<img src="./img/截屏2023-11-05 23.18.24.png" alt="截屏2023-11-05 23.18.24" style="zoom:33%;" />

差错报文：提取IP数据报的首部和数据字段前8个字节，在首部前面再加上ICMP差错报告报文的前8个字节，就构成了ICMP差错报告报文

<img src="./img/截屏2023-11-05 23.21.32.png" alt="截屏2023-11-05 23.21.32" style="zoom:33%;" />

不发送差错报告的情况

​	对ICMP差错报告报文不再发送差错报告报文

​	对第一个分片的数据报片的所有后续数据报片不发送

​	对多播数据报不发

​	对特殊地址数据报（eg. 127.0.0.0  0.0.0.0等）不发

#### 应用举例

略

### IPv6

#### 基本首部

IPv6地址从IPv4的32位增到128位。地址空间增大$2^{96}$倍 根本用不完！

空间大，地址层次划分可以更多

首部和IPv4不兼容，定义了许多可选扩展首部，灵活

改进的选项。IPv6允许数据报包含有选项的控制信息，可以包含一些新的选项，但是IPv6首部长度是固定的，选项放在有效载荷中

​	和4的区别，4的选项放在首部，是固定不变的

允许协议继续扩充

支持即插即用，不用DHCP

支持资源与分配

首部改为8字节对齐（IPV4是4字节对齐）

<img src="./img/截屏2023-11-05 23.29.43.png" alt="截屏2023-11-05 23.29.43" style="zoom:33%;" />



区别如下：

取消了首部长度字段，因为IPV6首部固定

取消服务类型字段

取消总长度字段，改用有效载荷长度字段

取消了标识、标志和片偏移字段，功能已包含在分片扩展首部中

TTL字段改为跳数限制字段，功能一样

取消了协议字段，该用下一首部字段

取消了检验和字段

取消了选项字段，用扩展首部来实现选项功能



<img src="./img/截屏2023-11-05 23.33.31.png" alt="截屏2023-11-05 23.33.31" style="zoom: 33%;" />



#### IPv6地址

地址类型分三种：

- 单播
- 多播
- 任播 增加的一种类型，发给一组计算机，只交付给最近的那一台

为了使地址简洁，用16进制记法，每4个数一个冒号：隔开

***零压缩***：对于数字0可以省略，0000则保留一个0，如果是一连串的0则用一对冒号::取代

<font color=Red>为防止歧义，任一地址中只能有一次零压缩</font>

CIDR斜线记法类似，但是前缀最后一位0不能省略（eg 12AB::CD30/60)

​	注：IPv6取消了子网掩码

<img src="./img/截屏2023-11-05 23.48.21.png" alt="截屏2023-11-05 23.48.21" style="zoom:33%;" />

#### IPv4向IPv6过度

##### 双协议栈

完全过渡到IPv6之前，使一部分主机（或路由器）同时装有IPv4和IPv6两种协议栈。 <font color=Red>代价大</font>

##### 隧道技术

在IPv6数据报要进入IPv4网络时，把它封装为IPv4数据报



#### ICMPv6

ICMPv6合并了ARP、IGMP功能

<img src="./img/截屏2023-11-05 23.56.07.png" alt="截屏2023-11-05 23.56.07" style="zoom:25%;" />

### 互联网路由选择协议

#### 基本概念

1.理想的路由算法

- 必须完整且正确

- 应该简单

- 能适应通信量和网络拓扑的变化——自适应性

- 有稳定性

- 应公平

- 应是最佳的

2.分层次的路由选择协议

​	互联网规模很大，可以划分为多个较小的自治系统（AS）

​		内部网关协议：IGP -> RIP or OSPF

​		外部网关协议：EGP -> BGP-4

#### 内部网关协议RIP

1.工作原理

​	RIP要求网络中每一个路由器维护从它自己到其他每一个目的网络的距离记录，直连定义为1，从一主机到非直接连接到网络的距离定义为所经过的路由器 +1 。

​	RIP的距离即“跳数”，RIP允许一条路径最多包含15个网络，因此距离为16时相当于不可达。所以 ***RIP只适用于小型互联网***。

​	关于RIP特点：

-  仅和相邻路由器交换信息
- 交换所知全部信息，即当前路由表
- 按固定时间间隔交换信息

<font color=Red>最开始路由表为空，路由器先得出相邻距离为1，后面多轮交换后路由表逐渐收敛</font>

2.距离向量算法

对 ***每一个相邻路由器*** 发送的RIP报文执行以下步骤：

（1）对地址为X的相邻路由器发来的RIP报文，先修改此报文中的 ***所有项目*** ：把“下一跳”字段的地址都改为X，所有“距离”字段值加1。

<font color=Red>每一个项目都有三个关键数据：到目的网络Net，距离d，下一跳路由器是X</font>

（2）对修改的RIP报文每一个项目进行如下步骤：

​	若原来路由表中没有目的网络Net，则把该项目添加到路由表

​	否则（即在路由表中有目的网络Net，这时就再查看下一跳路由器地址）

​		若下一跳地址是X，就把收到的项目替换原路由表中的项目

​		否则（即这个项目是：到目的网络Net但是下一跳路由器不是X）

​			若收到的项目等距离d小于路由表中的距离则进行更新

​			否则什么也不做

（3）若三分钟没收到相邻路由器的更新路由表，就把此相邻路由器距离设置为16（不可达）

（4）返回

#### 内部网关协议OSPF

1.基本特点

​	OSPF：开放最短路径优先

​	为了克服RIP缺点，使用Dijkstra算法，RIP以跳数测距，OSPF以传输速率测距

​	OSPF协议下，向本自治系统总所有路由器发送信息，使用 *** 洪泛法*** ，路由器通过所有输出端口向相邻路由器发信息，每个相邻路由器再将此信息发往其所有相邻路由器（但不发给传入信息的那个路由器），最终使得整个区域路由器都得到一个信息副本。

​	链路状态发生变化或每隔一段时间路由器就会用洪泛法发送链路状态信息

优点：OSPF收敛更快，可以知道全网的拓扑结构



2.OSFP的五种分组类型

- 问候分组
- 数据库描述分组
- 链路状态请求分组
- 链路状态更新分组
- 链路状态确认分组

OSPF是直接用IP数据报传送的：

<img src="./img/截屏2023-11-06 19.35.40.png" alt="截屏2023-11-06 19.35.40" style="zoom:33%;" />

#### 外部网关协议BGP

目前使用版本4，BGP-4

一个AS中有两种不同功能的路由器

- 边界路由器
- 内部路由器

BGP使用TCP连接

边界路由器之间用eBGP

在AS内部路由器之间用iBGP

BGP规定在AS内部所有的iBGP是全连通的，即使两个路由器之间没有物理连接，它们之间仍有iBGP连接

<img src="./img/截屏2023-11-06 19.46.09.png" alt="截屏2023-11-06 19.46.09" style="zoom:33%;" />



3.三种不同的自治系统AS

- 末梢AS	比较小的AS，特点是把分组发送给其直接连接的AS或从直接连接的AS接收分组，且要向所连接的AS付费，不会中转其他		   AS的分组
- 穿越AS
- 对等AS

<img src="./img/截屏2023-11-06 20.35.42.png" alt="截屏2023-11-06 20.35.42" style="zoom:33%;" />



4.BGP的路由选择

选择规则从上到下：

- 本地偏好LOCAL-PREFerence值最高的路由优先选择	从本AS开始到同一个前缀不同的BGP路由中挑选一个偏好值最高的路由，由											 管理员定义偏好
- 选择具有AS跳数最少的路由
- 热土豆算法 让分组尽快离开本AS
- 选择路由器BGP标识符数值最小的路由



5.BGP的四种报文

- OPEN（打开）报文			用来与BGP连接对等端建立关系
- UPDATE（更新）报文                    用来报告某一路由的信息，以及列出要撤销的路由
- KEEPALIVE（保活）报文                周期性证实对等端的连通性
- NOTIFICATION（通知）报文        发送检测到的差错

OPEN报文是两个路由器建立TCP连接后必须发送的报文

UPDATE报文是BGP协议的核心，撤销可以一次撤销多条，新增时一个报文只能新增一条路由

每个路由器都有 ***保持时间计时器*** ，每收到一个报文计时器就重置，到时间就认为对方已经不能工作了， KEEPALIVE报文发送时间间隔为双方事先商定的 ***保持时间*** 的1/3

旧的BGP报文使用2字节ASN，新的BGP使用4字节ASN，路径属性记为AS4-PATH

BGP是作为TCP报文的数据部分传送的

<img src="./img/截屏2023-11-06 20.57.12.png" alt="截屏2023-11-06 20.57.12" style="zoom:33%;" />

#### 路由器的构成

路由器分为

- 路由选择部分（控制部分）	根据选定的路由协议构造路由表，同时经常或定期和相邻路由交换信息而不断更新和维护路由表
- 分组转发部分
  - 交换结构（交换组织） 根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去
  - 输入端口
  - 输出端口

<img src="./img/截屏2023-11-06 21.00.19.png" alt="截屏2023-11-06 21.00.19" style="zoom:50%;" />

<font color=Red>注意“转发”只涉及一个路由器，“路由选择”涉及多个路由器</font>



<img src="./img/截屏2023-11-06 21.06.43.png" alt="截屏2023-11-06 21.06.43" style="zoom: 50%;" /><img src="./img/截屏2023-11-06 21.07.14.png" alt="截屏2023-11-06 21.07.14" style="zoom:50%;" />



分组丢弃

- 如果路由器处理分组的速率跟不上分组进入队列的速率，等到储存空间耗尽，后续分组会因为没有空间而被丢弃
- 路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。 
- 设备或线路设备故障也会引起分组丢失。

<img src="./img/截屏2023-11-06 21.10.11.png" alt="截屏2023-11-06 21.10.11" style="zoom: 33%;" />

### IP多播

#### IP多播的基本概念

能够运行多播协议的路由器称为 ***多播路由器***

IP多播本质上靠服务器发送多播数据报，被多播路由器识别后复制成几个副本分别发给下层路由器，到达局域网时因为局域网由硬件多播功能所以不需要继续复制分组

##### IP多播的特点

使用D类IP地址

- 多播地址只能用于目的地址，而不能用于源地址。

- 多播数据段首部的协议字段值位2——IGMP

- 对于多播数据报不产生ICMP差错报文

常用多播地址段：224.0.0.0/24

- 224.0.0.1   LAN上所有设备

- 224.0.0.2   LAN上所有路由器

- 224.0.0.5   LAN上所有OSPF路由器

- 224.0.0.251 LAN上所有DNS服务器



#### 局域网上硬件多播

<img src="./img/截屏2023-11-06 21.19.42.png" alt="截屏2023-11-06 21.19.42" style="zoom:50%;" />



<img src="./img/截屏2023-11-06 21.20.15.png" alt="截屏2023-11-06 21.20.15" style="zoom: 33%;" />

####  网际组管理协议IGMP和多播路由选择协议

1.IP多播需要两种协议

***IGMP***协议让连接在 ***本地局域网*** 上的多播路由器知道 ***本局域网*** 上是否有主机（上的某个进程）参加或退出了某个多播组

​	这样路由器可以将多播数据发给多播组的主机，不发给不再组内的主机

***多播路由选择协议***：保证多播转发动态适应多播组成员的变化，以最小代价吧多播数据报发送给所有组成员，使多播路由器协同工作

<font color=Red>注意：多播数据报可以由没有假如多播组的主机发出，也可以通过没有组成员接入的网络</font>

2.IGMP

IGMP用IP数据报传输，要加IP首部，属于IP一部分

ICMP工作分为两个阶段：

- 某台主机加入新的多播组，向多播组的多播地址发送一个IGMP报文声明要成为该组成员。本地多播路由器收到报文还要利用多播路由选择协议把这种组成员关系转发给互联网上的其他多播路由器
- 本地多播路由器周期性探询本局域网上的主机是否还继续时组的成员，只要有一台主机对某个组响应就认为这个组是活跃的。当一个组经过几次探询后依然没有一台主机响应，则不在把组成员关系发送给其他多播路由器

3.多播路由选择协议

本质是找出以源主机为根结点的 ***多播转发树*** ，在多播转发树上向叶节点方向转发的多播数据报不会兜圈子，即每个路由器不会收到重复的数据报

三种方法：

- 洪泛与剪除 适用于较小多播组
- 隧道技术 适用于多播组位置和地理很分散的情况
- 基于核心的发现技术 对于多播组的大小在较大范围内变化时都适合，对每一个多播组制定一个 ***核心路由器*** 给出它的IP单播地址。由核心路由器创建多播组的转发树



拓展：

DHCP ：动态主机配置协议

- 当主机加入IP网络，允许主机从DHCP服务器动态获取IP地址

- 可以有效利用IP地址，方便移动主机的地址获取

<img src="./img/截屏2023-11-06 21.51.01.png" alt="截屏2023-11-06 21.51.01" style="zoom: 33%;" />







